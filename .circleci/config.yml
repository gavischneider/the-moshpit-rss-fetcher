version: 2.1
orbs:
  node: circleci/node@3.0.0
jobs:
  build:
    docker:
      - image: circleci/node:13.8.0
    steps:
      - checkout
      - run:
          name: Build App Code
          command: |
            npm install
            npm run build

  test:
    docker:
      - image: circleci/node:13.8.0
    steps:
      - checkout
      - run:
          name: Test App
          command: |
            sudo npm install
            sudo npm install jest jest-cli ts-jest supertest typescript --global
            sudo npm run test
          environment:
            MONGO_CONNECTION_STRING: ${MONGO_CONNECTION_STRING}
            process.env.MONGO_CONNECTION_STRING: << pipeline.parameters.MONGO_CONNECTION_STRING >>

  scan:
    docker:
      - image: circleci/node:13.8.0
    steps:
      - checkout
      - run:
          name: Audit Dependencies
          command: |
            npm install
            npm audit fix --audit-level=critical --force

# workflows:
#   node-tests:
#     jobs:
#       - node/test

workflows:
  default:
    jobs:
      - build
      - test:
          requires: [build]
      - scan:
          requires: [test]
